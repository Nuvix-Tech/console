---
title: Multi-factor authentication
description: Add multiple layers of authentication to your applications powered by Nuvix Authentication.
---

Multi-factor authentication (MFA) greatly increases the security of your apps by adding additional layers of protection.
When MFA is enabled, a malicious actor needs to compromise multiple authentication factors to gain unauthorized access.
Nuvix Authentication lets you easily implement MFA in your apps, letting you build more securely and quickly.

<Info>
This page covers MFA for your app's end-users.
If you are looking for MFA on your Nuvix Console account, please refer to the Console MFA page.
</Info>

Nuvix currently allows two factors of authentication. More factors of authentication will be available soon.

Here are the steps to implement MFA in your application.

## 1. Display recovery codes

Initialize your Nuvix SDK's `Client`, `Account`, and `Avatars`.
You'll use Avatars API to generate a QR code for the TOTP authenticator app, you can skip this import if you're not using TOTP.

<CodeGroup>
```javascript JavaScript/TypeScript
import { Client, Avatars } from "@nuvix/client";

const client = new Client();

const account = client.account;
const avatars = client.avatars;

client
    .setEndpoint('https://api.nuvix.in/v1') // Your API Endpoint
    .setProject('<PROJECT_ID>'); // Your project ID
```
</CodeGroup>

Before enabling MFA, you should display recovery codes to the user.
The codes are single use passwords the user can use to access their account if they lose access to their MFA email,
phone, or authenticator app. These codes can **only be generated once**, warn the users to save them.

The code will look like this, display them to the user and remind them to save the codes in a secure place.

```json
{
    "recoveryCodes": [
        "b654562828",
        "a97c13d8c0",
        "311580b5f3",
        "c4262b3f88",
        "7f6761afb4",
        "55a09989be"
    ]
}
```

These codes can be used to complete the [Complete challenge](#complete-challenge) step if the user loses access to their MFA factors.
Generate the recovery codes by calling `account.createMfaRecoveryCodes()`.

<CodeGroup>
```javascript JavaScript/TypeScript
const response = await account.createMfaRecoveryCodes();
console.log(response.recoveryCodes);
```
</CodeGroup>

## 2. Verify MFA factors

Any verified email, phone number, or TOTP authenticator app can be used as a factor for MFA.
Before they can be used as a factor, they need to be verified.

<Tabs>
<Tab title="Email">
First, set your user's email if they haven't already.

<CodeGroup>
```javascript JavaScript/TypeScript
const response = await account.updateEmail({
    email: 'email@example.com',
    password: 'password'
});
```
</CodeGroup>

Then, initiate verification for the email by calling `account.createEmailVerification()`.
Calling `createEmailVerification` will send a verification email to the user's email address
with a link with the query parameter `userId` and `secret`.

<CodeGroup>
```javascript JavaScript/TypeScript
const res = await account.createVerification({
    url: 'https://example.com/verify-email'
});
```
</CodeGroup>

After the user clicks the link in the email, they will be redirected to your site with the query parameters `userId` and `secret`.
If you're on a mobile platform, you will need to create the appropriate deep link to handle the verification.

Finally, verify the email by calling `account.updateVerification()` with `userId` and `secret`.

<CodeGroup>
```javascript JavaScript/TypeScript
const response = await account.updateVerification({
    userId: '<USER_ID>',
    secret: '<SECRET>'
});
```
</CodeGroup>

</Tab>

<Tab title="Phone">
First, set your user's phone number if they haven't already.

<CodeGroup>
```javascript JavaScript/TypeScript
const response = await account.updatePhone({
    phone: '+12065550100',
    password: 'password'
});
```
</CodeGroup>

Then, initiate verification for the phone number by calling `account.createPhoneVerification()`.

<CodeGroup>
```javascript JavaScript/TypeScript
const response = await account.createPhoneVerification();
```
</CodeGroup>

After the user receives the verification code, they can verify their phone number by calling `account.updatePhoneVerification()`.

<CodeGroup>
```javascript JavaScript/TypeScript
const response = await account.updatePhoneVerification({
    userId: '<USER_ID>',
    secret: '<SECRET>'
});
```
</CodeGroup>

</Tab>

<Tab title="Authenticator">
First, add a TOTP authenticator to the user's account by calling `account.addAuthenticator()`.

<CodeGroup>
```javascript JavaScript/TypeScript
const { secret, uri } = await account.createMfaAuthenticator({
    type: 'totp'
});
```
</CodeGroup>

This will create a secret and a URI.
The URI is a URL that can be used to generate a QR code for the user to scan with their TOTP authenticator app.

You can generate a QR code for the user to scan by calling `avatars.getQR()`.

<CodeGroup>
```javascript JavaScript/TypeScript
const result = await avatars.getQR({
    text: uri,
    size: 800,  // optional
    margin: 0,  // optional
    download: false // optional
});

console.log(result); // Resource URL
```
</CodeGroup>

If the user is unable to scan QR codes, you can display the `secret` to the user.

Finally prompt the user to enter a TOTP from their authenticator app, then
verify the authenticator by calling `account.verifyMfaAuthenticator()`.

<CodeGroup>
```javascript JavaScript/TypeScript
const promise = account.updateMfaAuthenticator({
    type: 'totp',
    otp: '<OTP>'
});
```
</CodeGroup>

</Tab>
</Tabs>

## 3. Enable MFA on an account

You can enable MFA on your account by calling `account.updateMFA()`.
You will need to have added more than 1 factors of authentication to an account before
the MFA is enforced.

<CodeGroup>
```javascript JavaScript/TypeScript
const result = await account.updateMFA({
    enabled: true
});
```
</CodeGroup>

## 4. Initialize login

Begin your login flow with the default authentication method used by your app, for example, email password.

<CodeGroup>
```javascript JavaScript/TypeScript
const session = await account.createEmailPasswordSession({
    email: 'email@example.com',
    password: 'password'
});
```
</CodeGroup>

## 5. Check for multi-factor

Upon successful login in the first authentication step, check the status of the login by calling `account.get()`.
If more than one factors are required, you will receive the error `user_more_factors_required`.
Redirect the user in your app to perform the MFA challenge.

<CodeGroup>
```javascript JavaScript/TypeScript
try {
    const response = await account.get();
    console.log(response);
} catch (error) {
    console.log(error);
    if (error.type === `user_more_factors_required`){
        // redirect to perform MFA
    }
    else {
        // handle other errors
    }
}
```
</CodeGroup>

## 6. List factors

You can check which factors are enabled for an account using `account.listMfaFactors()`.
The returned object will be formatted like this.

```javascript
{
    totp: true, // time-based one-time password
    email: false, // email
    phone: true // phone
}
```

<CodeGroup>
```javascript JavaScript/TypeScript
const factors = await account.listMfaFactors();
// redirect based on factors returned.
```
</CodeGroup>

## 7. Create challenge

Based on the factors available, initialize an additional auth step.
Calling these methods will send a challenge to the user.
You will need to save the challenge ID to complete the challenge in a later step.

<Tabs>
<Tab title="Email">
Nuvix will use a verified email on the user's account to send the challenge code via email.
Note that this is only valid as a second factor if the user did not initialize their login with email OTP.

<CodeGroup>
```javascript JavaScript/TypeScript
const challenge = await account.createMfaChallenge({
    factor: 'email'
});

// Save the challenge ID to complete the challenge later
const challengeId = challenge.$id;
```
</CodeGroup>

</Tab>

<Tab title="Phone">
Nuvix will use a verified phone number on the user's account to send the challenge code via SMS.
You cannot use this method if the user initialized their login with phone OTP.

<CodeGroup>
```javascript JavaScript/TypeScript
const challenge = await account.createMfaChallenge({
    factor: 'phone'
});

// Save the challenge ID to complete the challenge later
const challengeId = challenge.$id;
```
</CodeGroup>

</Tab>

<Tab title="TOTP">

Initiate a challenge for users to complete using an authenticator app.

<CodeGroup>
```javascript JavaScript/TypeScript
const challenge = await account.createMfaChallenge({
    factor: 'totp'
});

// Save the challenge ID to complete the challenge later
const challengeId = challenge.$id;
```
</CodeGroup>

</Tab>
</Tabs>

## 8. Complete challenge

Once the user receives the challenge code, you can pass the code back to Nuvix to complete the challenge.

<CodeGroup>
```javascript JavaScript/TypeScript
const response = await account.updateMfaChallenge({
    challengeId: '<CHALLENGE_ID>',
    otp: '<OTP>'
});
```
</CodeGroup>

After completing the challenge, the user is now authenticated and all requests will be authorized.
You can confirm this by running `account.get()`

## 9. Recovery

In case your user needs to recover their account, they can use the recovery codes generated in the first step with the
recovery code factor. Initialize the challenge by calling `account.createMfaChallenge()` with the factor `recoverycode`.

<CodeGroup>
```javascript JavaScript/TypeScript
const challenge = await account.createMfaChallenge({
    factor: 'recoverycode'
});

// Save the challenge ID to complete the challenge later
const challengeId = challenge.$id;
```
</CodeGroup>

Then complete the challenge by calling `account.updateMfaChallenge()` with the challenge ID and the recovery code.

<CodeGroup>
```javascript JavaScript/TypeScript
const response = await account.updateMfaChallenge({
    challengeId: '<CHALLENGE_ID>',
    otp: '<RECOVERY_CODE>'
});
```
</CodeGroup>